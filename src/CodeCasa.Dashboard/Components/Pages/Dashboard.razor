@page "/"

@using CodeCasa.CustomEntities.InputSelect
@using CodeCasa.Dashboard.Components.Demo
@using CodeCasa.Dashboard.Components.Dashboard
@using CodeCasa.NetDaemon.Utilities.Entities
@using global::NetDaemon.HassModel.Entities
@using global::NetDaemon.RuntimeState

@inject NetDaemonRuntimeStateService NetDaemonConnectionStateService
@inject LivingRoomWallPanelView LivingRoomWallPanelView

<BackgroundPicture ToBackground="_homeScreenActive" />

@if (!_netDaemonInitialized)
{
    <MudAlert ContentAlignment="HorizontalAlignment.Center"
              Variant="Variant.Filled"
              style="background-color: rgba(33, 150, 243, 0.7);">Loading NetDaemon and Connecting to Home Assistant...</MudAlert>
}
else if (!_netDaemonConnected)
{
    <MudAlert ContentAlignment="HorizontalAlignment.Center"
              Variant="Variant.Filled"
              style="background-color: rgba(244, 67, 54, 0.7);">Disconnected From Home Assistant.</MudAlert>
}

@if (_netDaemonInitialized)
{
    <DemoMenu />

    <ScrollArea Visible="_homeScreenActive" />
    <Weather Visible="_homeScreenActive" />
}
 
<Clock Centered="@(!_homeScreenActive)" OnClick="ClockClicked" />
<Date Visible="_homeScreenActive" />

@code {
    private bool _netDaemonInitialized;
    private bool _netDaemonConnected;

    private bool _homeScreenActive;

    protected override void OnInitialized()
    {
        NetDaemonConnectionStateService.ConnectedChangesWithCurrent().Subscribe(state =>
        {
            var netDaemonWasAlreadyInitialized = _netDaemonInitialized;

            _netDaemonInitialized = state != NetDaemonStates.Initializing;
            _netDaemonConnected = state == NetDaemonStates.Connected;

            if (_netDaemonInitialized && !netDaemonWasAlreadyInitialized)
            {
                NetDaemonInitialized();
            }

            InvokeAsync(StateHasChanged);
        });
    }

    private void NetDaemonInitialized()
    {
        LivingRoomWallPanelView.StateChangesWithCurrent().Subscribe(state =>
        {
            _homeScreenActive = state.New?.State == LivingRoomWallPanelView.States.Home;
            InvokeAsync(StateHasChanged);
        });
    }

    private void ClockClicked()
    {
        if (!_netDaemonConnected || LivingRoomWallPanelView.State == LivingRoomWallPanelView.States.Idle)
        {
            return;
        }
        LivingRoomWallPanelView.SelectOption(LivingRoomWallPanelView.States.Idle);
    }
}

@* <style>
    body {
        background-color: black; /* For deployment to actual LCD screen */
    }
</style> *@