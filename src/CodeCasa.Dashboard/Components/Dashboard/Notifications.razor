@using System.Text.Json
@using CodeCasa.AutoGenerated
@using CodeCasa.Dashboard.Icons
@using CodeCasa.Dashboard.Resolvers
@using NetDaemon.HassModel
@using NetDaemon.HassModel.Entities
@using NetDaemon.InputSelectNotifications

@inject IHaContext HaContext
@inject InputSelectEntities InputSelectEntities

@for (var i = 0; i < _notifications.Length; i++)
{
    var index = i;
    var notification = _notifications[index];
    var icon = notification.Icon == null ? null : MudIcons.TryResolveMudIcon(notification.Icon);
    var iconColor = notification.IconColor == null ? Color.Inherit : MudColors.TryResolveMudColor(notification.IconColor) ?? Color.Inherit;
    
    <MudButton FullWidth="true" Variant="Variant.Filled" Color="Color.Dark">
        <MudStack Row AlignItems="AlignItems.Center" Style="justify-content: flex-start; width: 100%;" Class="ma-2">
            @if (icon != null)
            {
                @if (notification.BadgeIcon != null || string.IsNullOrEmpty(notification.BadgeContent))
                {
                    var badgeIcon = notification.BadgeIcon == null ? null : MudIcons.TryResolveMudIcon(notification.BadgeIcon);
                    var badgeIconColor = notification.BadgeColor == null ? Color.Inherit : MudColors.TryResolveMudColor(notification.BadgeColor) ?? Color.Inherit;
                    var badgeContent = ParseContent(notification.BadgeContent);
                    <MudBadge 
                        Overlap="true" 
                        Icon="@badgeIcon"
                              Content="@badgeContent"
                        Color="@badgeIconColor"
                        Class="mr-2">
                        <MudIcon Color="@iconColor" Icon="@icon" />
                    </MudBadge>
                }
                else
                {
                    <MudIcon Icon="@icon" Color="@iconColor" Class="mr-2" />
                }
            }
            <MudStack Spacing="0">
                <MudText Typo="Typo.body1">@notification.Message</MudText>
                @if (!string.IsNullOrEmpty(notification.SecondaryMessage))
                {
                    <MudText Typo="Typo.body2">@notification.SecondaryMessage</MudText>
                }
            </MudStack>
        </MudStack>
    </MudButton>
}

@code {
    private DashboardNotificationInfo[] _notifications = [];
    protected override void OnInitialized()
    {
        InputSelectEntities.LivingRoomPanelNotifications.StateAllChangesWithCurrent().Subscribe(stateChange =>
        {
            if (stateChange.New?.Attributes?.Options == null || string.IsNullOrEmpty(stateChange.New.Attributes.Options.FirstOrDefault()))
            {
                _notifications = [];
                return;
            }
            var jsonOptions = new JsonSerializerOptions
            {
                PropertyNameCaseInsensitive = true
            };
            _notifications = stateChange.New.Attributes.Options
                .Select(o => JsonSerializer.Deserialize<DashboardNotificationInfo>(o, jsonOptions))
                .Where(n => n != null)
                .Select(n => n!).ToArray();

            InvokeAsync(StateHasChanged).GetAwaiter().GetResult();
        });
    }

    private void NotificationClicked(int index)
    {
        HaContext.SendEvent("notification_clicked", new { notificationEntity = InputSelectEntities.LivingRoomPanelNotifications.EntityId, NotificationIndex = index });
    }

    private object? ParseContent(string? content)
    {
        if (content == null)
        {
            return null;
        }

        if (int.TryParse(content, out var i))
        {
            return i;
        }
        if (double.TryParse(content, out var d))
        {
            return d;
        }

        return content;
    }
}
